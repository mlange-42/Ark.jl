# ------------------------------------------------------------------------
# ⚠️ This file is auto-generated. DO NOT EDIT.
# Changes will be overwritten by the code generation process.
# ------------------------------------------------------------------------

{{#items}}
"""
    Query{{N}}{ {{joined}} }

A query for {{N}} components.
"""
mutable struct Query{{N}}{ {{joined}} }
    _index::Int
    _world::World
    _ids::Tuple{ {{tuple}} }
    _mask::_Mask
    {{#types}}
    _storage_{{lower}}::_ComponentStorage{ {{upper}} }
    {{/types}}
    _lock::UInt8
end

"""
    Query{{N}}{ {{joined}} }(world::World)

Creates a query for {{N}} components.
"""
function Query{{N}}{ {{joined}} }(world::World) where { {{joined}} }
    ids = (
        {{#types}}
        _component_id!(world, {{upper}}),
        {{/types}}
    )
    return Query{{N}}{ {{joined}} }(
        0,
        world,
        ids,
        _Mask(ids...),
        {{#types}}
        _get_storage(world, ids[{{n}}], {{upper}}),
        {{/types}}
        0,
    )
end

"""
    get_components(q::Query{{N}}{ {{joined}} })::Tuple{ {{columns}} }

Returns the component columns of the archetype at the current cursor position.
"""
@inline function get_components(q::Query{{N}}{ {{joined}} })::Tuple{ {{columns}} } where { {{joined}} }
    return q[]
end

@inline function Base.getindex(q::Query{{N}}{ {{joined}} })::Tuple{ {{columns}} } where { {{joined}} }
    {{#types}}
    {{lower}} = q._storage_{{lower}}.data[q._index]
    {{/types}}
    return {{values}}
end

@inline function Base.iterate(q::Query{{N}}, state::Int)
    q._index = state
    while q._index <= length(q._world._archetypes)
        archetype = q._world._archetypes[q._index]
        if _contains_all(archetype.mask, q._mask)
            return q._index, q._index + 1
        end
        q._index += 1
    end
    close(q)
    return nothing
end

@inline function Base.iterate(q::Query{{N}})
    q._lock = _lock(q._world._lock)
    q._index = 1
    return Base.iterate(q, q._index)
end

"""
    close(q::Query{{N}})

Closes the query and unlocks the world.
Must be called if a query is not fully iterated.
"""
function close(q::Query{{N}})
    q._index = 0
    _unlock(q._world._lock, q._lock)
end

{{/items}}